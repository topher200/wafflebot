# Update RSS Feed Service

This service handles generating and updating the RSS feed for the podcast by reading all audio files from the S3 bucket and uploading the generated RSS feed back to S3.

## Purpose

The `update-rss-feed` service scans the S3 bucket for all podcast audio files, generates a complete RSS feed, and uploads it to the S3 bucket for podcast distribution.

## How it Works

1. **Input**: Connects to S3 bucket using AWS credentials
2. **Processing**:
   - Lists all audio files in the `podcasts/` prefix
   - Generates RSS feed XML content (currently stub implementation)
   - Saves RSS feed locally for debugging
3. **Output**: Uploads the RSS feed to S3 at `rss/<feed_name>`

## Authentication

This service uses the same AWS authentication pattern as `publish-podcast-to-s3`. The credentials should be generated using `aws-vault` on the host machine and passed to the container via environment variables.

### Setting up credentials with aws-vault

On the host machine, use aws-vault to generate temporary credentials:

```bash
# Generate temporary credentials (valid for 1 hour by default)
aws-vault exec your-profile -- env | grep AWS_ > .env.aws
```

## Environment Variables

- `S3_BUCKET_NAME`: The name of the S3 bucket where podcasts are stored
- `RSS_FEED_NAME`: The name of the RSS feed file (optional, defaults to "podcast.xml")
- `AWS_ACCESS_KEY_ID`: AWS access key (generated by aws-vault)
- `AWS_SECRET_ACCESS_KEY`: AWS secret key (generated by aws-vault)
- `AWS_SESSION_TOKEN`: AWS session token (generated by aws-vault, if using temporary credentials)
- `AWS_REGION`: AWS region (optional, defaults to us-east-1)

## Docker Integration

The service is configured in `docker-compose.yml` as:

```yaml
update-rss-feed:
  build:
    context: .
  volumes:
    - rss-output:/app/data/rss # Local RSS output directory
    - .env.aws:/app/.env.aws:ro # AWS credentials only
  command: uv run python src/update-rss-feed/generate_rss.py
```

## Usage

The service can be run as part of the full pipeline or individually:

```bash
# Generate AWS credentials first
aws-vault exec your-profile -- env | grep AWS_ > .env.aws

# Run as part of the full pipeline
./run-wafflebot.sh

# Or run individually
docker compose run --rm update-rss-feed
```

## S3 Bucket Structure

The service reads from and writes to the S3 bucket with the following structure:

```
s3://your-bucket-name/
├── podcasts/                    # Input: podcast audio files
│   ├── 2025-01-15T143022.mp3
│   ├── 2025-01-16T091545.mp3
│   └── ...
└── rss/                         # Output: RSS feed
    └── podcast.xml              # Generated RSS feed
```

## RSS Feed Generation

The RSS feed generation is currently implemented as a stub function that creates a basic RSS 2.0 structure. This will be replaced with a proper RSS library implementation.

### Current Stub Implementation

- Creates basic RSS 2.0 XML structure
- Includes podcast metadata (title, description, language)
- Lists the number of episodes found
- Uses proper RSS content type and caching headers

### Future Implementation

The stub function `generate_rss_feed_content()` should be replaced with a proper RSS library that:

- Generates complete RSS 2.0 feed with iTunes podcast extensions
- Includes episode metadata (title, description, publication date, duration)
- Handles proper RSS formatting and validation
- Supports podcast-specific RSS features

## Error Handling

The service includes comprehensive error handling for:

- **NoS3CredentialsError**: Missing or invalid AWS credentials
- **S3AccessError**: S3 bucket access issues (permissions, bucket not found)
- **RSSGenerationError**: RSS feed generation failures

## Prerequisites

- AWS CLI installed in the Docker container (inherited from base image)
- aws-vault configured on the host machine with appropriate AWS credentials
- S3 bucket created (typically via Terraform infrastructure)
- Appropriate IAM permissions for S3 read and write operations

## Testing

```bash
# Run RSS feed tests
uv run pytest tests/unit/test_update_rss_feed.py -v
```

## Local Development

For local testing and debugging, the service saves the generated RSS feed to `data/rss/` directory before uploading to S3. This allows you to inspect the generated content locally.
